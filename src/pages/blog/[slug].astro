---
import BaseLayout from '../../layouts/BaseLayout.astro';
import * as contentful from 'contentful';
import { documentToHtmlString } from '@contentful/rich-text-html-renderer';

// getStaticPaths 函數 - 告訴 Astro 有哪些路徑
export async function getStaticPaths() {
  const client = contentful.createClient({
    space: import.meta.env.CONTENTFUL_SPACE_ID,
    accessToken: import.meta.env.CONTENTFUL_ACCESS_TOKEN,
    environment: 'master',
  });

  const response = await client.getEntries({
    content_type: 'blogPost',
  });

  return response.items.map((item: any) => ({
    params: { slug: item.fields.slug },
  }));
}

// 連接 Contentful
const client = contentful.createClient({
  space: import.meta.env.CONTENTFUL_SPACE_ID,
  accessToken: import.meta.env.CONTENTFUL_ACCESS_TOKEN,
  environment: 'master',
});

// 獲取 URL 參數
const { slug } = Astro.params;

// 根據 slug 獲取文章
const response = await client.getEntries({
  content_type: 'blogPost',
  'fields.slug': slug,
  limit: 1,
});

if (response.items.length === 0) {
  return Astro.redirect('/404');
}

const item = response.items[0];
const post = {
  title: item.fields.title,
  slug: item.fields.slug,
  date: new Date(item.fields.date).toISOString().split('T')[0],
  summary: item.fields.summary,
  category: item.fields.category,
  content: item.fields.content,
  coverImage: item.fields.coverImage?.fields?.file?.url 
    ? `https:${item.fields.coverImage.fields.file.url}` 
    : 'https://images.unsplash.com/photo-1621905251918-48416bd8575a?w=1200'
};

// 將 Rich Text 轉換為 HTML
const contentHtml = documentToHtmlString(post.content);
---

<style>
  .article-header {
    max-width: 900px;
    margin: 0 auto 3rem;
    text-align: center;
  }
  
  .article-category {
    display: inline-block;
    background: var(--accent);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 1rem;
  }
  
  .article-title {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2C3E50;
    margin-bottom: 1rem;
    line-height: 1.2;
  }
  
  .article-date {
    font-size: 1rem;
    color: #6B7280;
    margin-bottom: 2rem;
  }
  
  .article-cover {
    width: 100%;
    max-width: 900px;
    height: 400px;
    margin: 0 auto 3rem;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .article-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .article-content {
    max-width: 800px;
    margin: 0 auto;
    font-size: 1.125rem;
    line-height: 1.8;
    color: #374151;
  }
  
  .article-content :global(h2) {
    font-size: 1.875rem;
    font-weight: 600;
    color: #2C3E50;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
  }
  
  .article-content :global(h3) {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2C3E50;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }
  
  .article-content :global(p) {
    margin-bottom: 1.5rem;
  }
  
  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
  }
  
  .article-content :global(li) {
    margin-bottom: 0.5rem;
  }
  
  .article-content :global(strong) {
    font-weight: 600;
    color: #2C3E50;
  }
  
  .article-content :global(a) {
    color: var(--accent);
    text-decoration: underline;
  }
  
  .article-content :global(blockquote) {
    border-left: 4px solid var(--accent);
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: #6B7280;
  }
  
  .back-link {
    display: inline-block;
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .back-link:hover {
    transform: translateX(-5px);
  }
  
  @media (max-width: 768px) {
    .article-title {
      font-size: 2rem;
    }
    
    .article-cover {
      height: 250px;
    }
    
    .article-content {
      font-size: 1rem;
    }
  }
</style>

<BaseLayout title={`${post.title} - 青曦空間設計`}>
  <article style="padding: 4rem 1rem;">
    <div class="article-header">
      <span class="article-category">{post.category}</span>
      <h1 class="article-title">{post.title}</h1>
      <p class="article-date">{post.date}</p>
    </div>
    
    <div class="article-cover">
      <img src={post.coverImage} alt={post.title} />
    </div>
    
    <div class="article-content" set:html={contentHtml} />
    
    <div style="text-align: center; margin-top: 3rem;">
      <a href="/blog" class="back-link">← 返回知識分享</a>
    </div>
  </article>
</BaseLayout>
